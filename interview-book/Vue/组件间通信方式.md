# 组件间通信方式

组件间通信的分类：

- 父子组件之间的通信
- 兄弟组件之间的通信
- 祖孙与后代组件之间的通信
- 非关系组件之间的通信

组件间通信的实现方式：

1. 通过 props 传递数据
2. 通过$emit 触发自定义事件
3. 使用 ref
4. EventBus
5. $parent 和 $children
6. attrs 和 listeners
7. provide 和 inject
8. Vuex/pinia

## props 传递数据

- 适用于 父组件给子组件传递数据
- 子组件 设置 props 属性，定义接收父组件传递过来的参数
- 父组件在使用子组件变迁中通过字面量来传递值

children.vue

```js
props:{
  name: String
  age: {
    type: Number,
    default: 18,
    required: true
  },
  info: Object,
}
```

Father.vue

```js
<Children :name="name" :age="age" :info="info"></Children>
```

## $emit 触发自定义事件

- 适用于 子组件给父组件传递数据
- 子组件通过 $emit 触发自定义事件，$emit 第二个参数为传递给父组件的数据
- 父组件监听事件，并获取事件参数

children.vue

```js
this.$emit('myEvent', 'hello')
```

father.vue

```js
<Children @myEvent="handleMyEvent"></Children>
```

## ref

- 父组件在使用子组件的时候设置 ref
- 父组件通过设置子组件 ref 来获取数据

父组件

```js
;<Children ref='foo'></Children>

this.$refs.foo.xxx
```

## EventBus

-适用于兄弟组件传值

<!-- - 创建一个 EventBus.js 文件，在里面创建一个 Vue 实例，然后导出这个实例
 -->

- 创建一个中央时间总线 EventBus
- 兄弟组件通过 $emit 触发事件，$emit 第二个参数为传递的数据
- 另一个兄弟组件 通过 $on 监听事件

```js
// 创建一个中央时间总线类
class Bus {
  constructor() {
    this.callbacks = {} // 存放事件的名字
  }
  $on(name, fn) {
    this.callbacks[name] = this.callbacks[name] || []
    this.callbacks[name].push(fn)
  }
  $emit(name, args) {
    if (this.callbacks[name]) {
      this.callbacks[name].forEach((cb) => cb(args))
    }
  }
}

// main.js
Vue.prototype.$bus = new Bus() // 将$bus挂载到vue实例的原型上
// 另一种方式
Vue.prototype.$bus = new Vue() // Vue已经实现了Bus的功能
```

children1.vue

```js
this.$bus.$on('test', (data) => {})
```

children2.vue

```js
this.$bus.$emit('test', data)
```

## $parent 和 $children

通过共同祖辈 $parent 或者 $root 搭建通信
兄弟组件：
this.$parent.on('add', this.add)
另一个兄弟组件：
this.$parent.emit('add')

## $attrs 与 $listeners

- 适用于 祖先传递数据给子孙
- 设置批量向下传属性 $attrs 和 $listens
- 包含了父级作用域中不作为 prop 被识别（且获取）的特性绑定（class 和 style 除外:
  - 父组件使用子组件的时传递的属性，但没有在子组件的 props 中定义接收的，都会成为可传递的 $attrs
  - 在第一级子组件中，可以直接 通过 `$attrs`, `$listeners` 接收使用
  - 在除第一级子组件中，需要使用 `v-bind="$attrs"`, `v-on="$listeners"` 传入内部组件

```html
<template>
  <div>
    <p>我是 child 1</p>

    <p>$attrs in child1: {{ $attrs }}</p>
    <p>$listener in child1: {{ $listeners }}</p>
    <button @click="$emit('add', 123)">子组件触发 add</button>
    <son v-bind="$attrs" v-on="$listeners" />
    <son />
  </div>
</template>
<script>
  import son from './son1.vue'
  export default {
    props: {
      grade: String,
      score: Number,
      sum: Function,
    },
    components: {
      son,
    },
    mounted() {
      console.log('child1-mounted', this.$attrs)
      console.log('child1-mounted-listeners', this.$listeners)
    },
    methods: {},
  }
</script>
```

## provide 和 inject

- 适用于 祖先传递数据给后代组件
- 在祖先组件中，使用 provide 提供数据，在后代组件中使用 inject 接收数据

```js
// 祖先组件
provide(){
  return {
    foo: 'foo'
  }
}
// 后代组件
inject: ['foo']
```

### vuex

- state
- getter
- mutation
- action
